<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body>
    <div style="width:100%; overflow: hidden;">
    <div style="float: left; width:50%;">
    <div>
        <label>Search</label>
        <textarea id="searchtxtbox" name="rootpath" cols="60" rows="5" style="width:60%">
/Users/wubinwei/Documents
/Users/wubinwei/WarmData</textarea>
    </div>
    <button id="startbtn">Start</button>
    <input type="checkbox" id="cleanemptycb" checked><small>Empty</small></input>
    <input type="checkbox" id="findreplicatescb" checked><small>Replicates</small></input>
    </div>
    <div style="float: right; width:50%;">
        <div>
            <label>Backup</label>
            <textarea id="backuptxtbox" name="rootpath" cols="60" rows="5" style="width:60%">
/Volumes/5TDisk/01 HotData
/Volumes/5TDisk/02 WarmData</textarea>
        </div>
        <button id="comparebtn">Compare</button>
        <!-- <button id="startbackupbtn">Start Backup</button> -->
        <!-- <button id="cleanrubbishbtn">Find Rubbish</button> -->
        <input type="checkbox" id="compressbtn" checked><small>Compress Repository</small></input>
    </div>
    </div>
    <br>
    <table id="overviewtb" style="width:100%"></table><br>
    <table id="resultempty" style="width:100%"></table><br>
    <table id="resultduplicates" style="width:100%"></table><br>
    <div id="btndiv" hidden>
        <button id="cleanupbtn">Confirm Clean-up</button>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    $('#startbtn').click(function() {
        var resultempty = $('#resultempty');
        var resultduplicates = $('#resultduplicates');
        resultempty.empty();
        resultduplicates.empty();
        $('#btndiv').hide();

        var cleanempty = $('#cleanemptycb').prop('checked');
        var findreplicates = $('#findreplicatescb').prop('checked');

        $.get('http://localhost:3001/overview', { rootpath:$('#searchtxtbox').val(), cleanempty:cleanempty, findreplicates:findreplicates }, function(data) {
            var overviewtb = $('#overviewtb');
            overviewtb.empty().append('<caption>Overview</caption><tr><th>path</th><th>size</th><th>count</th></tr>');
            overviewList = JSON.parse(data).overview;
            var totalsize = 0;
            var totalcount = 0;
            overviewList.forEach(function(element){
                overviewtb.append('<tr><td>'+element.path+'</td><td>'+numberWithCommas(element.size)+'</td><td>'+element.count+'</td></tr>');
                totalsize += element.size;
                totalcount += element.count;
            });
            overviewtb.append('<tr><td>TOTAL'+'</td><td>'+numberWithCommas(totalsize)+'</td><td>'+totalcount+'</td></tr>');
            
            if (cleanempty) {
                emptyList = JSON.parse(data).findings.emptyList;
                if (emptyList.length > 0) {
                    resultempty.empty().append('<caption>Empty</caption><tr><th>Path</th><th>Is Directory</th></tr>');
                    emptyList.forEach(function(element) {
                        resultempty.append('<tr><td><label><input type="checkbox" checked>'+element.path+'</label></td><td>'+element.isDirectory+'</td></tr>');
                    });
                    $('#btndiv').show();
                }
            }
            
            if (findreplicates) {
                resultduplicates.empty();
                var duplicatesList = JSON.parse(data).findings.duplicatesList;
                if (duplicatesList.length > 0) {
                    var idx = 0;
                    resultduplicates.append('<div><b>Duplicated files are found, select to remove.</b></div><br>')
                    duplicatesList.forEach(function(elem) {
                        resultduplicates.append('<div>File size:  '+numberWithCommas(elem.filesize) + '<br>');
                        elem.files.forEach(function(element) {
                            resultduplicates.append('<label><input type="radio" name="'+idx+'">'+element+'</label><br>');
                        });
                        resultduplicates.append('<br></div>');
                        idx++;
                    });
                    $('#btndiv').show();
                }
            }
        });
    });

    $('#cleanupbtn').click(function() {
        var removefiles = [];
        $("input[type=radio]:checked").parent('label').each(function() {
            removefiles.push(this.textContent);
        });
        $("input[type=checkbox]:checked").parent('label').each(function() {
            removefiles.push(this.textContent);
        });
        
        $.post('http://localhost:3001/cleanup', { data: JSON.stringify(removefiles) }, function(data) {
        });
    });

    $('#comparebtn').click(function() {
        $.get('http://localhost:3001/compare', { rootpath:$('#searchtxtbox').val(), backuprootpath:$('#backuptxtbox').val()}, function(data) {
            var resulttb = $('#resulttb');
            resulttb.empty();
            var resultduplicates = $('#resultduplicates');
            resultduplicates.empty();
            $('#btndiv').hide();

            var overviewtb = $('#overviewtb');
            overviewtb.empty().append('<caption>Overview</caption><tr><th>path</th><th>type</th></tr>');
            overviewList = JSON.parse(data).data;
            if (overviewList.onlySrc) {
                overviewList.onlySrc.forEach(function(element) {
                    overviewtb.append('<tr><td><label>'+element.src+'</td><td>onlySrc</td></tr>');
                });
            }
            if (overviewList.differentContent) {
                overviewList.differentContent.forEach(function(element) {
                    overviewtb.append('<tr><td><label>'+element.src+'</td><td>differentContent</td></tr>');
                });
            } 
        });
    });

    $('#cleanrubbishbtn').click(function() {
        var currentdata = null;
        $.get('http://localhost:3001/cleanrubbish', {rootpath:$('#searchtxtbox').val()}, function(data) {
            var resulttb = $('#resulttb');
            resulttb.empty().append('<tr><th>Path</th><th>Is Directory</th></tr>');
            currentdata = JSON.parse(data).data;
            currentdata.forEach(function(element) {
                resulttb.append('<tr><td>'+element.path+'</td><td>'+element.isDirectory+'</td></tr>');
            });
            $('#btndiv').show();
            //currenttask = 'cleanrubbish';
        });
    });

    $('#compressbtn').click(function() {
        var currentdata = null;
        $.post('http://localhost:3001/compress', {data: JSON.stringify(currentdata) }, function(data) {
        });
    });
    </script>
</body>
</html>